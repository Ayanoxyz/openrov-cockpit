<dom-module name="orov-settings-manager">
<script src="/js/libs/jsoneditor.min.js"></script>

<template>
  <div id='form1'>
  </div>
  <button on-click='save'>Save</button>
</template>
<script>
(function() {
  var editor;
  Polymer({
    is:'orov-settings-manager',
    properties: {
      eventEmitter: {type: Object, readOnly: true, observer: 'eventEmitterChange'},
      schema: {type: Object},
      value: {type: Object},
      editor: {type: Object},
      editorOptions: {type: Object, value: {
        theme: null,
        disable_edit_json: true,
        disable_properties: true
      }}
    },
    eventEmitterChange: function(){
      var self = this;
      if (this.eventEmitter !== undefined){
        this.eventEmitter.on('plugin.thrusters2x1.setting',function(data){
          self.smoothingIncriment = data.smoothingIncriment;
        });
      }
    },
    save: function(){
      var data = this.editor.getValue();
      this.fire('save',data);
      if (this.eventEmitter !== undefined){
        this.eventEmitter.emit('plugin.settings-manager.persist-data',data);
      }
    },
    ready: function(){
      var self = this;

      if(this.eventEmitter !== undefined){
        /*
          The timing for this works because the manager class has already been loaded
          and its listen method for the plugin called before the UI renders.  So the
          manager already interrogated all of the plugins meta data for the
          settings schemas
        */
        this.eventEmitter.emit('plugin.settings-manager.getSchemas',function(schema){
          self.schema = schema;
          console.log(schema);
          var _self = self;

          /* Go ahead and create a new blank form, then pull in
             any existing values that had been persisted.  In that
             way we don't create a broken form that is missing
             fields.
          */
          self.eventEmitter.emit('plugin.settings-manager.getSettings',function(settings){
            _self.value = settings;
            _self.editorOptions['schema'] = schema;
            _self.editor = new JSONEditor(_self.$.form1, _self.editorOptions);
            var defaults = _self.editor.getValue();
            //zips the object properies in to _self.value
            Object.assign(_self.value,defaults);
            _self.editor.setValue(_self.value);
          })

        });


      } else {
        this.editor = new JSONEditor(this.$.form1, schema);
      }

    }
  })
})();
</script>
</dom-module>
