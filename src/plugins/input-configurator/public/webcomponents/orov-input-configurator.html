<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">
<link rel="import" href="../paper-item/paper-item.html">">
<link rel="import" href="../paper-listbox/paper-listbox.html">">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<dom-module name="orov-input-configurator">
    <style include="foundation5-styles"></style>
    <style include="normalized-styles"></style>

    <style type="text/css">
        .row.full-width {
            width: 100%;
            max-width: 100%;
        }
        
        #controls {
            height: 150px;
            border: solid 1px black;
            overflow: scroll;
        }
        
        .successfullySaved {
            opacity: 1;
        }
        
        .successfullySaved.hide {
            opacity: 0;
            display: block;
            transition: opacity 1.5s ease-out;
        }
        
        .header {
            font-weight: bold;
        }
        
        .currentItem {
            background-color: #dff0d8;
        }
        
        .controlsRow:hover {
            background-color: #ddd;
        }
        
        .hidden {
            display: none;
        }
    </style>
    <template>
        <h2>{{__('Input configurator')}}</h2>

        <div id="controls" class="center">
            <div id="commandsList" class="table">
                <div class="header">
                    <div style="float:left; min-width:40%">{{__('Command')}}</div>
                    <div style="">{{__('Description')}}</div>
                </div>
                <iron-list id="list" items="[[commands]]" as="item" selected-item="{{selectedItem}}" selection-enabled>
                    <template>
                        <div class$="controlsRow [[getClassForItem(item, selected)]]">
                            <div style="float:left; min-width:40%">{{__(item.name)}}</div>
                            <div style="">{{__(item.description)}}</div>
                        </div>
                    </template>
                </iron-list>
            </div>
        </div>

        <div class="row full-width">
            <div class="small-6 columns">
                <div class="row collapse prefix-radius">
                    <div class="small-2 columns">
                        <label class="prefix" for="find">{{__('Find')}}:</label>
                    </div>
                    <div class="small-3 columns left">
                        <input id="find" type="text" value="{{find::input}}" />
                    </div>
                </div>
            </div>
        </div>

        <div class$="[[showEditor(selectedItem)]]">

            <div class="row full-width">
                <div class="small-6 columns">
                    <div class="row collapse prefix-radius">
                        <div class="small-2 columns">
                            <label class="prefix" for="keyboard">{{__('Keyboard')}}:</label>
                        </div>
                        <div class="small-3 columns left">
                            <input id="keyboard" type="text" class$="{{ getClassInCaseOfDupplicates(keyboardDuplicates.*, 'error') }}" value="{{selectedItem.bindings.keyboard}}"
                            />
                            <small class$="[[ getClassInCaseOfDupplicates(keyboardDuplicates.*, 'error', 'hide') ]]">{{__('Duplicate!')}}</small>
                        </div>
                    </div>

                    <div class="row collapse prefix-radius">
                        <div class="small-2 columns">
                            <label class="prefix" for="gamepad">{{__('Gamepad')}}:</label>
                        </div>
                        <div class="small-3 columns left">
                            <input id="gamepad" type="text" class$="{{ getClassInCaseOfDupplicates(gamepadDuplicates.*, 'error') }}" value="{{__(selectedItem.bindings.gamepad)}}" />
                            <small class$="[[ getClassInCaseOfDupplicates(gamepadDuplicates.*, 'error', 'hide') ]]">{{__('Duplicate!')}}</small>
                        </div>
                    </div>


                </div>
            </div>
            <div class="row full-width">
                <div class$="small-12 columns {{ getClass(duplicates, '', 'hide') }}">
                    Duplicates:
                    <div class="row full-width">
                        <div class="small-9 columns left">
                            <iron-list id="keyboardList" items="[[keyboardDuplicates]]" as="item">
                                <template>
                                    <div class$="controlsRow [[getClassForItem(item, selected)]]">
                                        <div style="float:left; min-width:40%">{{__(item.name)}}</div>
                                        <div style="">{{__(item.description)}}</div>
                                    </div>
                                </template>
                            </iron-list>
                           <iron-list id="gamepadList" items="[[gamepadDuplicates]]" as="item">
                                <template>
                                    <div class$="controlsRow [[getClassForItem(item, selected)]]">
                                        <div style="float:left; min-width:40%">{{__(item.name)}}</div>
                                        <div style="">{{__(item.description)}}</div>
                                    </div>
                                </template>
                            </iron-list>

                        </div>
                    </div>
                </div>

                <div class="row full-width">
                    <div class="small-6 columns">
                        <button on-tap="onSave" type="button" class$="button {{ getClass(duplicates,'secondary disabled') }}">{{__('Save')}}</button>
                        <button on-tap="onReset" type="button" class="button">{{__('Reset')}}</button>
                    </div>

                    <div class="small-6 columns">
                        <div class$="small-4 columns successfullySaved {{ getClass(successfullySaved, '', 'hide') }}">
                            <div data-alert class="alert-box success">
                                {{__('Binding saved!')}}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="row full-width">
            <div class="small-12 columns">
                <div class="small-8 columns">
                    <paper-dropdown-menu id="preset" label="Presets">
                        <paper-listbox class="dropdown-content" selected="{{selectedPreset}}">
                            <template is="dom-repeat" items="{{presets}}" as="p">
                                <paper-item>{{p.name}}</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <button on-tap="onLoadPreset" type="button" class$="button {{ getClass(canLoadPreset,'', 'secondary disabled') }}">{{__('Load')}}</button>
                    <button on-tap="onSavePreset" type="button" class$="button {{ getClass(canSavePreset, '', 'secondary disabled') }}">{{__('Save')}}</button>
                    <button on-tap="onDeletePreset" type="button" class$="button {{ getClass(canSavePreset, '', 'secondary disabled') }}">{{__('Delete')}}</button>
                    <button on-tap="onWantSavePreset" type="button" class$="button {{ getClass(saveNewPreset, 'secondary disabled') }}">{{__('Save new preset')}}</button>

                    <div class$="successfullySaved {{ getClass(presetLoaded, '', 'hide') }}">
                        <div data-alert class="alert-box success">
                            {{__('Loaded!')}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row full-width">
            <div class="small-12 columns">
                <div class="small-4 columns">
                    
                    
                    <div class$="{{ getClass(saveNewPreset, '', 'hide' )}}">
                        <paper-input label="Save a new preset" floatingLabel value="{{newPresetName}}"></paper-input>
                        <button on-tap="onSaveNewPreset" type="button" class="button">{{__('Save')}}</button>
                    </div>

                </div>
            </div>
        </div>


    </template>
    <script>
    (function() {

      var keyboardMap = ["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","RETURN","","SHIFT","CTRL","ALT","PAUSE","CAPSLOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESC","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9",":",";","LESS_THAN","=","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","WIN","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","\"","#","$","%","&","_","(",")","*","+","|","HYPHEN_MINUS","{","}","~","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","",";","=",",","-",".","/","`","","","","","","","","","","","","","","","","","","","","","","","","","","","[","\\","]","'","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];

      Polymer({
        is: "orov-input-configurator",
        properties: {
          find: {type: String, value: '', observer: 'findChanged'},
          commands: {type: Array, value: []},
          unfilteredCommands: {type: Array, value: []},
          prests: {type: Array, value: []},
          selectedPreset: {type: Object, value: -1, observer: 'selectedPresetChanged'},
          presetLoaded: {type: Boolean, value: false},
          selectedItem: {type: Object, value: undefined, observer: '' },
          keyboardDuplicates: {type: Array, value: []},
          gamepadDuplicates: {type: Array, value: []},
          duplicates: {type: Boolean, computed: 'hasDuplicates(keyboardDuplicates.*, gamepadDuplicates.*)'},
          successfullySaved: {type: Boolean, value: false},
          saveNewPreset: {type: Boolean, value: false},
          canSavePreset: {type: Boolean, computed: 'getCanSavePreset(selectedPreset)'},
          canLoadPreset: {type: Boolean, computed: 'getCanLoadPreset(selectedPreset)'},
        },
        behaviors: [namespace('behaviors').oROVStandard],
    
        attached: function () {
          var self = this;
          if (this.eventEmitter!==undefined){
            this.eventEmitter.emit('InpitController.suspendAll')
              
            self.async(function() { self.$.list.dispatchEvent(new Event('iron-resize')); }, 500);

            $(self.$.keyboard).keydown(function(event) {
                var value = keyboardMap[event.which].toLowerCase();
                        if (value !== 'alt' && event.altKey) {
                        value = "alt+" + value;
                        }
                        if (value !== 'ctrl' && event.ctrlKey) {
                        value = "ctrl+" + value;
                        }
                        if (value !== 'shift' && event.shiftKey) {
                        value = "shift+" + value;
                        }
                $(self.$.keyboard).val(value);
                self.keyboardDuplicates = [];
                self.unfilteredCommands.forEach(function(command) {
                    if (command.bindings.keyboard === value && command != self.selectedItem) {
                        self.push('keyboardDuplicates', command);
                    }
                });
                event.preventDefault();
            });

          }
        },
        detached: function() {
            if (this.eventEmitter!==undefined){
                this.eventEmitter.emit('InpitController.resumeAll')
            }
        },
        registerEmitterHanlders: function(emitter){
            var self = this;

            emitter.withHistory.on('plugin.inputConfigurator.currentMap.update', function(keyMap) {
                self.unfilteredCommands = keyMap.map(function(mapping) { // map from array to object 
                    var result = { 
                        name: mapping.name, 
                        description: mapping.description ? mapping.description : '', 
                        bindings: {},
                        defaults: mapping.defaults 
                    };
                    mapping.bindings.forEach(function(binding) {
                        result.bindings[binding.name] = binding.binding;
                    });
                    return result;
                });
                self.updateCommands();
            });

            emitter.withHistory.on('plugin.inputConfigurator.presets.update', function(presets) {
                self.presets = presets;
            });

            emitter.on('InputController.registeredCommand',function(command){
                self.push('commands',command);
            });

            var checkForGamepadDuplicate = function(button) {
                self.gamepadDuplicates = [];
                self.unfilteredCommands.forEach(function(command) {
                    if (command.bindings.gamepad === button && command != self.selectedItem) {
                        self.push('gamepadDuplicates', command);
                    }
                });
            }

            //TODO Add dupplicates handling!
            emitter.on('systemPlugin.inputController.gamepad.buttonDown', function(button) {
                if (self.selectedItem) {
                    checkForGamepadDuplicate(button);
                    $(self.$.gamepad).val(button);   
                }
            });
            
            emitter.on('systemPlugin.inputController.gamepad.axisChanged', function(axis) {
                if (self.selectedItem) {
                    checkForGamepadDuplicate(button);
                    $(self.$.gamepad).val(axis);   
                }
            });         
        },
        enable: function(e){
        },
        disable: function(e){
        },
        
        selectedItemChanged: function() {
            if (this.selectedItem) {
                $(this.$.keyboard).val(this.selectedItem.bindings.keyboard);
                $(this.$.gamepad).val(this.selectedItem.bindings.gamepad);
                this.keyboardDuplicates = [];
            }
        },

        selectedPresetChanged: function() {
            if (this.selectedPreset >= 0) {
                console.log(this.presets[this.selectedPreset].name);
            }
        },

        findChanged: function() {
            this.updateCommands();
        },
        
        commandsChanged: function() {
            var self = this;
            self.selectedItem = undefined;
        },
        
        onSave: function(e) {
            var self = this;
            if (this.selectedItem) {
                this.selectedItem.bindings.keyboard = $(this.$.keyboard).val();
                this.selectedItem.bindings.gamepad = $(this.$.gamepad).val();
            }
            if (this.eventEmitter!==undefined) {
                var arg = { name: this.selectedItem.name, bindings: [
                    { name: 'keyboard', binding: this.selectedItem.bindings.keyboard },
                    { name: 'gamepad', binding: this.selectedItem.bindings.gamepad },
                ] };

                this.eventEmitter.emit('plugin.inputConfigurator.updateBinding', arg, function() {
                    self.set('successfullySaved', true);
                    self.async(function() { self.set('successfullySaved', false); }, 2000);
                });
            }
        },

        onLoadPreset: function(e) {
            var self = this;
            if (self.eventEmitter!==undefined) {
                self.eventEmitter.emit('plugin.inputConfigurator.loadPreset', self.presets[self.selectedPreset], 
                function(){
                    self.set('presetLoaded', true);
                    self.async(function() { self.set('presetLoaded', false); }, 2000);
                });
            }
        },

        onDeletePreset: function() {
            var self = this;
            if (self.eventEmitter!==undefined) {
                self.eventEmitter.emit('plugin.inputConfigurator.deletePreset', self.presets[self.selectedPreset], function() {
                    self.set('selectedPreset', -1);
                });
            }
        },

        onWantSavePreset: function() {
            this.set('saveNewPreset', true);
        },

        onSaveNewPreset: function() {
            var self = this;
            if (self.eventEmitter) {
                self.eventEmitter.emit('plugin.inputConfigurator.saveNewPreset', self.newPresetName);
                self.set('saveNewPreset', false);
            }
        },
        onSavePreset: function() {
            var self = this;
            if (self.eventEmitter) {
                self.eventEmitter.emit('plugin.inputConfigurator.savePreset', self.presets[self.selectedPreset]);
                self.set('saveNewPreset', false);
            }
        },

        getClass: function(duplicates, duplicateClass, nonDuplicateClass) {
            if (duplicates) {
              return duplicateClass;
            }  
            return nonDuplicateClass ? nonDuplicateClass : '';
        },

        onReset: function() {
            if (this.selectedItem) {
                $(this.$.keyboard).val(this.selectedItem.defaults.keyboard);
                $(this.$.gamepad).val(this.selectedItem.defaults.gamepad);
                this.keyboardDuplicates = [];
                this.gamepadDuplicates = [];
            }
        },
        
        getClassInCaseOfDupplicates: function(list, duplicateClass, nonDuplicateClass) {
          if (list.base.length > 0) {
              return duplicateClass;
          }  
          return nonDuplicateClass ? nonDuplicateClass : '';
        },
        hasDuplicates: function(keyboadDuplicates, gamepadDuplicates) {
            return keyboadDuplicates.base.length > 0 || gamepadDuplicates.base.length > 0;
        },
        
        getClassForItem: function(item, selected) {
          return selected ? 'currentItem' : '';
        },
        showEditor: function(selectedItem) {
          return selectedItem === null ? 'hidden' : '';  
        },
        getCanSavePreset: function(selectedPreset) {
            var self = this;
            if (selectedPreset >= 0) {
                var preset = self.presets[selectedPreset];
                return preset.default === undefined || preset.default === false;
            }
            return false;
        },
        getCanLoadPreset: function(selectedPreset) {
            var self = this;
            return (selectedPreset >= 0);
        },
        updateCommands: function() {
            var self = this;
            var filtered = this.unfilteredCommands;
            if (this.find.length > 0) { 
                filtered = 
                    this.unfilteredCommands.filter(function(item) {
                    var search = self.find.toLowerCase();
                    var nameContains = item.name.toLowerCase().indexOf(search) >= 0 ;
                    var descContains = item.description.toLowerCase().indexOf(search) >= 0;
                    return nameContains || descContains;
                    });
            }
            else {
                self.commands = self.unfilteredCommands;
                return;
            }
            var newCommands = [];
            if (filtered) {
                filtered.forEach(function(item) {
                    newCommands.push(item);
                });        
            }
            self.commands = newCommands;
        }
        
      })
    })();
  </script>

</dom-module>