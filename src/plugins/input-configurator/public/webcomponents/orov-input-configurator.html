<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">
<link rel="stylesheet" href="../../../components/bootstrap/dist/css/bootstrap.min.css">

<dom-module name="orov-input-configurator">
    <style type="text/css">
      #controls {
        height: 150px;
        border: solid 1px black;
        overflow: scroll;
      }
      
      .header {
          font-weight: bold;
      }
      
      .currentItem {
          background-color: #dff0d8;
      }
      
      .row:hover {
          background-color: #ddd;
      }
      
      .hidden {
          display: none;
      }


    </style>
  <template>
      <p>&nbsp;<br/><br/><br/><br/></p>
      <label>{{__('Input configurator')}}</label>

      <div id="controls" class="center">
        <div id="commandsList" class="table">
            <div class="header">
                <div style="float:left; min-width:40%">{{__('Command')}}</div>
                <div style="">{{__('Description')}}</div>
            </div>
            <iron-list id="list" items="[[commands]]" as="item" selected-item="{{selectedItem}}" selection-enabled >
                <template>
                    <div class$="row [[getClassForItem(item, selected)]]">
                        <div style="float:left; min-width:40%">{{__(item.name)}}</div>
                        <div style="">{{__(item.description)}}</div>
                    </tr>
                </template>
            </iron-list>
        </div>
        </div>
        <label for="find">{{__('Find')}}:</label>
        <input id="find" type="text" value="{{find::input}}" /> 
        <div class$="[[showEditor(selectedItem)]]">
            <label for="keyboard">{{__('Keyboard')}}:</label>
            <input id="keyboard" type="text" value="{{selectedItem.bindings.keyboard}}" />
            <label for="gamepad">{{__('Gamepad')}}:</label>
            <input id="gamepad" type="text" value="{{__(selectedItem.bindings.gamepad)}}" />
            <button on-tap="onSave">Save</button>
            <button on-tap="onReset">Reset</button>
        </div>
  </template>
  <script>
    (function() {

      var keyboardMap = ["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","RETURN","","SHIFT","CTRL","ALT","PAUSE","CAPSLOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESC","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9",":",";","LESS_THAN","=","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","WIN","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","\"","#","$","%","&","_","(",")","*","+","|","HYPHEN_MINUS","{","}","~","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","",";","=",",","-",".","/","`","","","","","","","","","","","","","","","","","","","","","","","","","","","[","\\","]","'","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];

      Polymer({
        is: "orov-input-configurator",
        properties: {
          find: {type: String, value: '', observer: 'findChanged'},
          commands: {type: Array, value: []},
          unfilteredCommands: {type: Array, value: []},
          selectedItem: {type: Object, value: undefined},
          selectedItems: {type: Object},
          commandFoo: {type: Array, value: [{name: 'a', description: 'aa'}, {name: 'b', description:'bb'}]}
        },
        behaviors: [namespace('behaviors').oROVStandard],
    
        attached: function () {
          var self = this;
          if (this.eventEmitter!==undefined){

            this.eventEmitter.emit('InputController.getCommands',function(results){
                self.unfilteredCommands = results;
                self.updateCommands();

                // The polymer iron-list is a bit funny when you don't size it absolutely.
                // On the first load it doesn't show items properly, this fixes it:                
                self.$.list.dispatchEvent(new Event('iron-resize'));
            });


            $(self.$.keyboard).keydown(function(event) {
                var value = keyboardMap[event.which].toLowerCase();
                        if (value !== 'alt' && event.altKey) {
                        value = "alt+" + value;
                        }
                        if (value !== 'ctrl' && event.ctrlKey) {
                        value = "ctrl+" + value;
                        }
                        if (value !== 'shift' && event.shiftKey) {
                        value = "shift+" + value;
                        }
                $(self.$.keyboard).val(value);
                event.preventDefault();
            });

          }
        },
        registerEmitterHanlders: function(emitter){
            var self = this;
            emitter.on('InputController.registeredCommand',function(command){
                self.push('commands',command);
            });
            
            emitter.on('systemPlugin.inputController.gamepad.buttonDown', function(button) {
                if (self.selectedItem) {
                    $(self.$.gamepad).val(button);   
                }
            });
            
            emitter.on('systemPlugin.inputController.gamepad.axisChanged', function(axis) {
                if (self.selectedItem) {
                    $(self.$.gamepad).val(axis);   
                }
            });         
        },
        enable: function(e){
        //   if (this.eventEmitter!==undefined){
        //     this.eventEmitter.emit('plugin-manager.enablePlugin',e.model.item.name);
        //   }
        },
        disable: function(e){
        //   if (this.eventEmitter!==undefined){
        //     this.eventEmitter.emit('plugin-manager.disablePlugin',e.model.item.name);
        //   }
        },

        findChanged: function() {
            this.updateCommands();
        },
        
        commandsChanged: function() {
            var self = this;
            self.selectedItem = undefined;
        },
        
        onSave: function(e) {
            this.selectedItem.bindings.keyboard = $(this.$.keyboard).val();
            this.selectedItem.bindings.gamepad = $(this.$.gamepad).val();

            //todo: save
        },

        onReset: function() {
            $(this.$.keyboard).val(this.selectedItem.bindings.keyboard);
            $(this.$.gamepad).val(this.selectedItem.bindings.gamepad);
        },
        
        getClassForItem: function(item, selected) {
          return selected ? 'currentItem' : '';
        },
        showEditor: function(selectedItem) {
          return selectedItem === null ? 'hidden' : '';  
        },
        updateCommands: function() {
            var self = this;
            var filtered = this.unfilteredCommands;
            if (this.find.length > 0) { 
                filtered = 
                    this.unfilteredCommands.filter(function(item) {
                    var search = self.find.toLowerCase();
                    var nameContains = item.name.toLowerCase().indexOf(search) >= 0 ;
                    var descContains = item.description.toLowerCase().indexOf(search) >= 0;
                    return nameContains || descContains;
                    });
            }
            else {
                self.commands = self.unfilteredCommands;
                return;
            }
            var newCommands = [];
            if (filtered) {
                filtered.forEach(function(item) {
                    newCommands.push(item);
                });        
            }
            self.commands = newCommands;
        }
        
      })
    })();
  </script>

</dom-module>
