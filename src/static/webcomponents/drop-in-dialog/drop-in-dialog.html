<link rel="import" href="../polymer/polymer.html">

<dom-module id="drop-in-dialog">

  <style>
      .contentContainer {
        height: 90%;
        overflow: auto;
      }
    </style>
  <template>

      <div class="drop-in-right" id="{{childId}}">
      <div class="back-button"></div>
      <h2>{{ header }}</h2>
      <div class="accordion contentContainer" id="{{_computeId(childId)}}">
        <content id="childItems" select="div"></content>
      </div>
    </div>

  </template>
  <script>
    (function () {
      Polymer({
        is: 'drop-in-dialog',
        properties: {
          childId: {
            type: String,
            value: '',
            notify: true
          },
          closeHandlers: {
            type: Array,
            value: function () {
              return [];
            }
          },
          collapseHandlerRegistered: {
            type: Boolean,
            value: false
          },
          header: {
            type: String,
            value: ''
          },
          settings: {
            value: function () {
              return undefined;
            }
          }
        },
        open: function () {
          this.settings.css('display', 'block');
          var self = this;
          Mousetrap.bind('esc', function () {
            self.hide();
          });
          this.registerCollapseHandler();
        },
        registerCloseHandler: function (handler) {
          this.closeHandlers.push(handler);
        },
        hide: function () {
          this.settings.css('display', 'none');
          Mousetrap.unbind('esc');
          this.closeHandlers.forEach(function (handler) {
            handler();
          });
        },
        registerCollapseHandler: function () {
          if (this.collapseHandlerRegistered) {
            return;
          }
          var distNodes = Polymer.dom(this.$.childItems).getDistributedNodes();
          distNodes.array().forEach(function (node) {
            var res = $(node).find('a.accordion-toggle');
            if (res && res.length > 0) {
              var href = res.attr('href');
              var element = $(node).find(href);
              res.click(function () {
                element.collapse('toggle');
              });
            }
          });
          this.collapseHandlerRegistered = true;
        },
        attached: function () {
          var self = this;
          this.settings = $(this.$[this.childId]);
          this.settings.find('.back-button').click(function () {
            self.hide();
          });
        },
        _computeId: function (childId) {
          return childId + '_';
        }
      });
    }());
  </script>
</dom-module>
